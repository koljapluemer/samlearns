{% extends "cms/german_with_videos/base.html" %}
{% load humanize %}
{% load lucide %}
{% block content %}
<div class="container">
    <div class="content">
        <!-- Back to list link -->
        <a href="{% url 'cms:german_with_videos:list_all_videos' %}" class="button is-text is-link mb-5">
                {% lucide "arrow-left" %}
            <span>Back to All Videos</span>
        </a>

        <!-- Video ID and Status -->
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title is-3">Video: {{ video.youtube_id }}</h1>
                    <span class="tag is-light ml-3">Priority: {{ video.priority }}</span>
                </div>
            </div>
            <div class="level-right">
                {% include "cms/german_with_videos/includes/video_status.html" %}
            </div>
        </div>

        <!-- YouTube Title -->
        <div class="box mb-5">
            <h2 class="title is-4">YouTube Title</h2>
            {% if video.youtube_title %}
                <p class="subtitle">{{ video.youtube_title }}</p>
                {% if video.channel_name %}
                    <p class="has-text-grey">Channel: {{ video.channel_name }}</p>
                {% endif %}
            {% else %}
                <p class="has-text-grey">No title available</p>
            {% endif %}
        </div>

        <!-- Tags -->
        <div class="box mb-5">
            <h2 class="title is-4">Tags</h2>
            
            <!-- Add Tag Form -->
            <form action="{% url 'cms:german_with_videos:add_tag' video.youtube_id %}" method="post" class="mb-4">
                {% csrf_token %}
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input type="text" 
                               name="tag_name" 
                               id="tagInput" 
                               class="input" 
                               placeholder="Add a new tag..."
                               autocomplete="off"
                               data-autocomplete-url="{% url 'cms:german_with_videos:tag_autocomplete' %}">
                    </div>
                    <div class="control">
                        <button type="submit" class="button is-primary">Add Tag</button>
                    </div>
                </div>
                <div id="tagSuggestions" class="dropdown is-hidden">
                    <div class="dropdown-menu">
                        <div class="dropdown-content"></div>
                    </div>
                </div>
            </form>

            <!-- Existing Tags -->
            {% if video.tags.all %}
                <div class="tags">
                    {% for tag in video.tags.all %}
                        <form action="{% url 'cms:german_with_videos:remove_tag' video.youtube_id tag.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="tag is-delete is-medium"></button>
                            <span class="tag is-medium {% if tag.type == 'from_youtube' %}is-warning{% elif tag.type == 'from_search' %}is-success{% elif tag.type == 'manual' %}is-info{% else %}is-light{% endif %}">
                                {{ tag.name }}
                            </span>
                        </form>
                    {% endfor %}
                </div>
            {% else %}
                <p class="has-text-grey">No tags assigned</p>
            {% endif %}
        </div>

        <!-- Video Player -->
        <div class="box mb-5 {% if video.status == 'blacklisted' %}has-background-grey-lighter{% endif %}">
            <div class="video-container">
                <iframe 
                    src="https://www.youtube.com/embed/{{ video.youtube_id }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
        </div>

        <!-- Status Update -->
        <div class="box mb-5">
            <h2 class="title is-4">Update Video Status</h2>
            <form action="{% url 'cms:german_with_videos:update_video_status' video.youtube_id %}" method="post">
                {% csrf_token %}
                <div class="field">
                    <label class="label">Select new status:</label>
                    <div class="control">
                        <div class="select">
                            <select name="status" id="status_select">
                                {% for status_value, status_label in video_status_choices %}
                                    <option value="{{ status_value }}" {% if video.status == status_value %}selected{% endif %}>
                                        {{ status_label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            Update Status
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Video Info -->
        <div class="columns">
            <!-- Available Subtitles -->
            <div class="column">
                <div class="box">
                    <h2 class="title is-4">Available Subtitles</h2>
                    {% if video.available_subtitle_languages %}
                        <div class="tags">
                            {% for lang in video.available_subtitle_languages %}
                                <span class="tag is-light">
                                    {{ lang }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="has-text-grey">No subtitles available</p>
                    {% endif %}
                    
                    {% if video.video_views or video.video_likes %}
                        <div class="mt-4 pt-4 has-border-top">
                            <div class="level">
                                {% if video.video_views %}
                                    <div class="level-item">
                                        <span class="icon-text">
                                            {% lucide "eye" %}
                                            <span>{{ video.video_views|intcomma }} views</span>
                                        </span>
                                    </div>
                                {% endif %}
                                {% if video.video_likes %}
                                    <div class="level-item">
                                        <span class="icon-text">
                                            {% lucide "thumbs-up" %}
                                            <span>{{ video.video_likes|intcomma }} likes</span>
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Snippets -->
            <div class="column">
                <div class="box">
                    <h2 class="title is-4">Snippets</h2>
                    <p class="subtitle">
                        This video has {{ snippet_count }} snippet{{ snippet_count|pluralize }}.
                    </p>
                    <div class="buttons">
                        {% if video.status != 'snippets_generated' and video.status != 'snippets_and_translations_generated' and video.status != 'live' %}
                            <form action="{% url 'cms:german_with_videos:generate_snippets' video.youtube_id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="button is-primary">
                                    Generate Snippets
                                </button>
                            </form>
                        {% endif %}
                        
                        {% if video.status == 'snippets_generated' %}
                            <form action="{% url 'cms:german_with_videos:generate_translations' video.youtube_id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="button is-success">
                                    Generate Translations
                                </button>
                            </form>
                        {% endif %}

                        {% if video.status == 'snippets_and_translations_generated' %}
                            <form action="{% url 'cms:german_with_videos:publish_video' video.youtube_id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="button is-info">
                                    Publish Video
                                </button>
                            </form>
                        {% endif %}

                        {% if video.status == 'snippets_generated' or video.status == 'snippets_and_translations_generated' or video.status == 'live' %}
                            <form action="{% url 'cms:german_with_videos:reset_snippets' video.youtube_id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="button is-danger">
                                    Reset Snippets
                                </button>
                            </form>
                        {% endif %}

                        {% if video.snippets.exists %}
                            <a href="{% url 'cms:german_with_videos:export_snippets_csv' video.youtube_id %}" 
                               class="button is-light">
                                Export Snippets CSV
                            </a>
                        {% endif %}

                        {% if video.status != 'blacklisted' %}
                            <form action="{% url 'cms:german_with_videos:blacklist_video' video.youtube_id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="button is-dark">
                                    Blacklist Video
                                </button>
                            </form>
                        {% endif %}

                        {% if video.status == 'blacklisted' %}
                            <form action="{% url 'update_video_statuses' %}" method="post" class="field has-addons">
                                {% csrf_token %}
                                <input type="hidden" name="status_{{ video.youtube_id }}" value="needs_review">
                                <div class="control">
                                    <div class="select">
                                        <select name="status_{{ video.youtube_id }}">
                                            <option value="needs_review">Needs Review</option>
                                            <option value="shortlisted">Shortlisted</option>
                                            <option value="longlisted">Longlisted</option>
                                            <option value="not_relevant">Not Relevant</option>
                                            <option value="snippets_generated">Snippets Generated</option>
                                            <option value="snippets_and_translations_generated">Snippets and Translations Generated</option>
                                            <option value="live">Live</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-success">
                                        Change Status
                                    </button>
                                </div>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Comment -->
        {% if video.comment %}
            <div class="box mt-5">
                <h2 class="title is-4">Comment</h2>
                <p>{{ video.comment }}</p>
            </div>
        {% endif %}

        <!-- Words Summary -->
        <div class="box mt-5">
            <details class="details">
                <summary class="summary">
                    <h2 class="title is-4">All Words</h2>
                    {% lucide "chevron-down" %}
                </summary>
                <div class="content mt-4">
                    {% if words %}
                        <div class="columns is-multiline">
                            {% for word in words %}
                                <div class="column is-half">
                                    <div class="notification is-light">
                                        <div class="title is-5">{{ word.original_word }}</div>
                                        <div class="content">
                                            {% for meaning in word.meanings.all %}
                                                <p>{{ meaning.en }}</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="has-text-grey">No words available. Click "Generate Translations" to create them.</p>
                    {% endif %}
                </div>
            </details>
        </div>

        <!-- Snippets List -->
        <div class="box mt-5">
            <details class="details">
                <summary class="summary">
                    <h2 class="title is-4">All Snippets</h2>
                    {% lucide "chevron-down" %}
                </summary>
                <div class="content mt-4">
                    {% for snippet in video.snippets.all %}
                        <div class="notification is-light mb-4">
                            <div class="level is-mobile">
                                <div class="level-left">
                                    <div class="level-item">
                                        <code>{{ snippet.start_time|floatformat:0 }}s - {{ snippet.end_time|floatformat:0 }}s</code>
                                    </div>
                                </div>
                            </div>
                            <p class="mb-4">{{ snippet.content }}</p>
                            
                            <!-- Words in this snippet -->
                            <div class="content">
                                <h3 class="title is-5">Words:</h3>
                                <div class="columns is-multiline">
                                    {% for word in snippet.words.all %}
                                        <div class="column is-half">
                                            <div class="notification is-light">
                                                <div class="title is-6">{{ word.original_word }}</div>
                                                <div class="content">
                                                    {% for meaning in word.meanings.all %}
                                                        {% if meaning.snippet_context == snippet %}
                                                            <p>{{ meaning.en }}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="column">
                                            <p class="has-text-grey">No words available for this snippet.</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p class="has-text-grey">No snippets available. Click "Generate Snippets" to create them.</p>
                    {% endfor %}
                </div>
            </details>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tagInput = document.getElementById('tagInput');
    const suggestionsDiv = document.getElementById('tagSuggestions');
    let timeoutId;

    tagInput.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const query = this.value.trim();
        
        if (query.length < 2) {
            suggestionsDiv.classList.add('is-hidden');
            return;
        }

        timeoutId = setTimeout(() => {
            fetch(`${tagInput.dataset.autocompleteUrl}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const dropdownContent = suggestionsDiv.querySelector('.dropdown-content');
                    dropdownContent.innerHTML = '';
                    if (data.tags.length > 0) {
                        data.tags.forEach(tag => {
                            const a = document.createElement('a');
                            a.className = 'dropdown-item';
                            a.textContent = tag.name;
                            a.addEventListener('click', () => {
                                tagInput.value = tag.name;
                                suggestionsDiv.classList.add('is-hidden');
                            });
                            dropdownContent.appendChild(a);
                        });
                        suggestionsDiv.classList.remove('is-hidden');
                    } else {
                        suggestionsDiv.classList.add('is-hidden');
                    }
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!tagInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.classList.add('is-hidden');
        }
    });
});
</script>
{% endblock %} 