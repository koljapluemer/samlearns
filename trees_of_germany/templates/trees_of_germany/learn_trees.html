{% extends "trees_of_germany/base.html" %}

{% block content %}
{# Pass data safely to JavaScript #}
{{ species_options|json_script:"species-options" }}
{{ tree_image.id|json_script:"tree-image-id" }}
{{ correct_species.id|json_script:"correct-species-id" }}

<div class="columns is-centered">
    <div class="column is-half">
        <div class="box" x-data="{ 
            selected: null,
            correctSpeciesId: JSON.parse(document.getElementById('correct-species-id').textContent),
            pageLoadTime: Date.now(),
            clickCount: 0,
            db: null,
            speciesOptions: JSON.parse(document.getElementById('species-options').textContent),
            treeImageId: JSON.parse(document.getElementById('tree-image-id').textContent),

            initDB() {
                const request = indexedDB.open('TreeLearningDB', 1);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('learningEvents')) {
                        db.createObjectStore('learningEvents', { autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                };
            },

            logLearningEvent(speciesId) {
                this.clickCount++;
                const timeElapsed = Date.now() - this.pageLoadTime;
                
                const eventData = {
                    timestamp: new Date().toISOString(),
                    selectedSpecies: this.speciesOptions.find(s => s.id === speciesId).latin_name,
                    availableOptions: this.speciesOptions.map(s => s.latin_name),
                    wasCorrect: speciesId === this.correctSpeciesId,
                    timeElapsedMs: timeElapsed,
                    imageId: this.treeImageId,
                    clickNumber: this.clickCount,
                };

                const transaction = this.db.transaction(['learningEvents'], 'readwrite');
                const store = transaction.objectStore('learningEvents');
                store.add(eventData);
            },

            handleClick(speciesId) {
                this.logLearningEvent(speciesId);
                this.selected = speciesId;
                if (speciesId === this.correctSpeciesId) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        }" x-init="initDB()">
            <div class="buttons is-centered mb-4">
                {% for species in species_options %}
                <button 
                    class="button is-large species-option"
                    :class="{ 
                        'is-light': selected === {{ species.id }} && selected !== correctSpeciesId,
                        'is-success': selected === {{ species.id }} && selected === correctSpeciesId 
                    }"
                    :disabled="selected === {{ species.id }} && selected !== correctSpeciesId"
                    @click="handleClick({{ species.id }})"
                >
                    <div class="has-text-centered">
                        <div class="is-size-4">{{ species.german_name }}</div>
                        <div class="is-size-6 has-text-grey">{{ species.latin_name }}</div>
                        <div class="is-size-6 has-text-grey">{{ species.english_name }}</div>
                    </div>
                </button>
                {% endfor %}
            </div>

            <div class="image-container" style="position: relative; width: 524px; margin: 0 auto;">
                <img src="{{ tree_image.get_usable_url }}" alt="Tree to identify" style="width: 100%; height: auto; display: block;">
                {% if tree_image.credit_user_name and tree_image.credit_url %}
                <div style="position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.5); padding: 0.25rem 0.5rem; border-radius: 4px 0 0 0;">
                    <a href="{{ tree_image.credit_url }}" target="_blank" rel="noopener noreferrer" class="has-text-white is-size-7">
                        Â© {{ tree_image.credit_user_name }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 