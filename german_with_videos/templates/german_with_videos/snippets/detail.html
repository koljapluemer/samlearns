{% extends "german_with_videos/base.html" %}
{% load lucide %}

{% block german_with_videos_content %}
    {% csrf_token %}
    <div class="container is-max-widescreen">
        <div class="columns is-centered">
            <div class="column">
                <div x-data="flashcards"
                     x-init="init({{ words_json }}, {{ snippet_data }})">
                    
                    <template x-if="currentWord">
                        <div>
                            <!-- Flashcard -->
                            <div class="box has-text-centered py-6">
                                <!-- Word Display -->
                                <h2 class="title is-1 mb-6" x-text="currentWord.original_word"></h2>
                                
                                <!-- Meanings (Hidden by default) -->
                                <div x-show="showMeanings" 
                                     x-transition:enter="transition ease-out duration-300"
                                     x-transition:enter-start="opacity-0 transform -translate-y-4"
                                     x-transition:enter-end="opacity-100 transform translate-y-0"
                                     class="mb-6">
                                    <hr class="is-dashed mb-6">
                                    <div class="content is-size-1">
                                        <template x-for="meaning in currentWord.meanings">
                                            <p class="mb-4" x-text="meaning"></p>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div class="buttons is-centered mt-5">
                                <template x-if="!showMeanings">
                                    <button @click="revealWord" 
                                            class="button is-primary is-large">
                                        <span>Reveal</span>
                                    </button>
                                </template>
                                
                                <template x-if="showMeanings">
                                    <button @click="nextWord" 
                                            class="button is-success is-large">
                                        <span class="icon">
                                            {% lucide "arrow-right" size=24 %}
                                        </span>
                                        <span>Next Word</span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="!currentWord">
                        <div class="has-text-centered">
                            <h2 class="title is-4 mb-6">Practice Complete!</h2>
                            
                            <!-- Video Player -->
                            <figure class="image is-16by9">
                                <iframe 
                                    :src="'https://www.youtube.com/embed/' + snippetData.youtube_id + '?autoplay=1&start=' + snippetData.start_time + '&end=' + snippetData.end_time"
                                    frameborder="0"
                                    class="has-ratio"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            </figure>
                            
                            <div class="buttons is-centered mt-6">
                                <template x-if="snippetData.next_snippet_url">
                                    <a :href="snippetData.next_snippet_url" 
                                       class="button is-primary is-large">
                                        <span class="icon">
                                            {% lucide "arrow-right" size=24 %}
                                        </span>
                                        <span>Practice Next Snippet</span>
                                    </a>
                                </template>
                                
                                <template x-if="!snippetData.next_snippet_url">
                                    <a href="{% url 'german_with_videos:video_detail' snippet.video.youtube_id %}" 
                                       class="button is-primary is-large">
                                        <span class="icon">
                                            {% lucide "arrow-left" size=24 %}
                                        </span>
                                        <span>Back to Video</span>
                                    </a>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('flashcards', () => ({
                words: [],
                currentIndex: 0,
                showMeanings: false,
                snippetData: null,
                learningEvents: [],
                anonId: null,
                
                async init(wordsData, snippetData) {
                    this.words = wordsData;
                    this.snippetData = snippetData;
                    this.anonId = this.getOrCreateAnonId();
                },

                getOrCreateAnonId() {
                    let anonId = localStorage.getItem('german_with_videos_anon_id');
                    if (!anonId) {
                        anonId = crypto.randomUUID();
                        localStorage.setItem('german_with_videos_anon_id', anonId);
                    }
                    return anonId;
                },

                async logInteraction(word, action) {
                    this.learningEvents.push({
                        anon_id: this.anonId,
                        original_word_string: word,
                        selected_button: action,
                        snippet_identifier: `${this.snippetData.video.youtube_id}_${this.snippetData.index}`
                    });
                },
                
                get currentWord() {
                    return this.words[this.currentIndex];
                },
                
                async revealWord() {
                    this.showMeanings = true;
                    await this.logInteraction(this.currentWord.original_word, 'reveal');
                },
                
                async nextWord() {
                    await this.logInteraction(this.currentWord.original_word, 'next');
                    this.showMeanings = false;
                    this.currentIndex++;
                    
                    if (!this.currentWord) {
                        await this.saveLearningEvents();
                    }
                },

                async saveLearningEvents() {
                    if (this.learningEvents.length === 0) return;
                    
                    try {
                        const response = await fetch("{% url 'german_with_videos:log_learning_events' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                events: this.learningEvents
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Failed to save learning events: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                        }
                        
                        this.learningEvents = [];
                    } catch (error) {
                        console.error('Error saving learning events:', error);
                    }
                }
            }))
        })
    </script>
{% endblock %} 